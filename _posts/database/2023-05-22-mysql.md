---
layout: post
title: Real MySQL 8.0
date: 2023-05-22
categories: [database, mysql]
tags: [database, mysql]
---
# Real MySQL 8.0
docker image를 사용해 container 환경에서 공부

> 예제 github: https://github.com/wikibook/realmysql80

***
## 환경 세팅

### MySQL 설치
아래를 각자의 환경에 맞게 설정 후, `docker compose up -d`
```yml
version: '3.8'

services:
  mysql:
    image: mysql:8.0.30
    container_name: mysql
    ports:
      - 3306:3306
    volumes:
      - ~/database/mysql/MySQL_8.0.30/MySQL:/var/lib/mysql
      - ~/database/mysql/MySQL_8.0.30/tmp:/tmp
      - ~/database/mysql/MySQL_8.0.30/etc:/etc/mysql/conf.d
    environment:
      - MYSQL_ROOT_PASSWORD=root_password
      - --character-set-server=utf8mb4
      - T/Z=Asia/Seoul
    command: mysqld --general-log=1 --general-log-file=/tmp/general_log.log
```

### database, data settings
1. 예제파일의 employees.sql을 container 내부의 `/tmp`로 이동(`~/database/mysql/MySQL_8.0.30/tmp`)
2. `docker exec -it ${container_name} /bin/bash`로 mysql container 접속
3. `mysql -u root -p` 입력 후 `docker-compose.yml`에서 설정한 root password 입력
4. `CREATE DATABASE employees DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_0900_ai_ci;`
5. `USE employees;`
6. `SOURCE /tmp/employees.sql`

### mysql server 구조
- bin: MySQL 서버와 클라이언트 프로그램, 유틸리티를 위한 directory
- include: C/C++ 헤더 파일들이 저장된 directory
- lib: 라이브러리 파일들이 저장된 directory
- share: 다양한 지원 파일, 에러 메시지, 샘플 설정 파일(my.ini)가 있는 directory
- /etc/my.cnf: 서버를 실행하는데 필요한 설정
  - 처음에는 기본적인 설정 3~4개만 존재
  - 실제 서비스용으로 사용할 계획이면 세부 설정 필요
- /var/log/mysqld.log: 에러 로그 파일의 기본 경로

### mysql 설정
- `mysqld --defaults-file=/etc/my.cnf --initialize-insecure`
  - 필요한 초기 데이터 파일과 로그 파일 생성
  - 비밀번호가 없는 관리자 계정인 root 계정 생성(비밀번호를 설정하려면 `--initialize-insecure` 대신에 `--initialize` 옵션 사용)

**mysql 종료 시 트랜잭션이 정상 커밋돼도 데이터 파일에 변경된 내용이 기록되지 않고 로그 파일(리두 로그)에만 기록되어 있을 수 있다. 심지어 서버가 종료 후 다시 시작된 후에도 이 상태로 남아있을 수 있다. 이는 비정상적인 상황이 아니다. 서버가 종료될 때 모든 커밋 내용을 데이터 파일에 기록하고 종료하게 할 수 있다.**
- `mysql$ SET GLOBAL innodb_fast_shutdown=0;`

**이를 clean shutdown이라고 한다. clean shutdown하면 서버 기동 시, 별도의 트랜잭션 복구 과정을 진행하지 않기 때문에 빠르게 시작 가능하다.**
